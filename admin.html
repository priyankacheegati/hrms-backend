<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; }
.navbar { display:flex; justify-content:space-between; padding:10px 20px; background:#333; color:white; }
.nav-user span { margin-right:10px; }
.logout-btn { cursor:pointer; padding:5px 10px; background:#F44336; border:none; border-radius:4px; color:white; }

.dashboard-content { display:flex; }
.sidebar { width:220px; background:#f1f1f1; padding:20px; }
.menu-item { padding:10px; cursor:pointer; border-radius:6px; margin-bottom:5px; }
.menu-item.active, .menu-item:hover { background:#2196F3; color:white; }
.main-content { flex:1; padding:20px; min-height:calc(100vh - 50px); }

.employee-list li { cursor:pointer; color:blue; margin-bottom:5px; }
.employee-list li:hover { text-decoration:underline; }
.card { background:#f4f4f4; padding:15px; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1); font-size:16px; }
.employee-card { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:15px; width:250px; text-align:center; }
.employee-card img { width:80px; height:80px; border-radius:50%; object-fit:cover; margin-bottom:10px; }
.employee-card h4 { margin:5px 0; }
.employee-card p { margin:2px 0; font-size:14px; color:#555; }
.employee-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; margin-top:20px; }
.status-active { color:green; font-weight:bold; }
.status-inactive { color:red; font-weight:bold; }
table { border-collapse:collapse; width:100%; margin-top:20px; }
table th, table td { border:1px solid #999; padding:6px 10px; text-align:left; }
table th { background:#eee; }
button { cursor:pointer; }
</style>
</head>
<body>

<div id="dashboard" class="dashboard">
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-title">Admin Dashboard</div>
    <div class="nav-user">
      <span>{{ user.name }}</span>
      <button class="logout-btn" onclick="window.location.href='/logout'">Logout</button>
    </div>
  </nav>

  <div class="dashboard-content">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="menu-item active" onclick="loadPage('overview')">📊 Overview</div>
      <div class="menu-item" onclick="loadPage('employee-management')">👥 Employee Management</div>
      <div class="menu-item" onclick="loadPage('department-management')">🏢 Department Management</div>
      <div class="menu-item" onclick="loadPage('attendance-leave')">📅 Attendance & Leave</div>
      <div class="menu-item" onclick="loadPage('payroll-management')">💰 Payroll Management</div>
      <div class="menu-item" onclick="loadPage('reports-analytics')">📈 Reports & Analytics</div>
      <div class="menu-item" onclick="loadPage('settings')">⚙ Settings</div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div id="page-content">
        <h2>Welcome Admin</h2>
        <p>Select an option from the sidebar to manage data.</p>
      </div>
    </main>
  </div>
</div>

<script>
// ---------------- Load Page Function ----------------
function loadPage(page) {
  document.querySelectorAll('.menu-item').forEach(el=>el.classList.remove('active'));
  document.querySelector(`.menu-item[onclick="loadPage('${page}')"]`).classList.add('active');

  const content = document.getElementById('page-content');

  // --- Overview ---
  if(page==='overview') {
    fetch('/api/overview_data').then(r=>r.json()).then(data=>{
      content.innerHTML=`
        <h2>Dashboard Overview</h2>
        <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:30px;">
          <div class="card">👥 Total Employees: ${data.total_employees}</div>
          <div class="card">📅 Present Today: ${data.present_today}</div>
          <div class="card">🌴 On Leave: ${data.on_leave}</div>
          <div class="card">🏢 Departments: ${data.departments}</div>
        </div>
        <div style="display:flex; gap:40px; flex-wrap:wrap;">
          <div style="width:300px;"><h3>Attendance Split</h3><canvas id="attendancePie"></canvas></div>
          <div style="width:400px;"><h3>Joining Trend</h3><canvas id="joiningBar"></canvas></div>
        </div>`;
      new Chart(document.getElementById('attendancePie'), { type:'pie', data:{labels:['Present','Absent','Leave'], datasets:[{data:[data.present_today,data.absent_today,data.on_leave], backgroundColor:['#4CAF50','#FF5252','#FFC107']}] } });
      new Chart(document.getElementById('joiningBar'), { type:'bar', data:{labels:data.joining_months, datasets:[{label:'New Employees', data:data.joining_counts, backgroundColor:'#2196F3'}]}, options:{ scales:{ y:{ beginAtZero:true }}}});
    });
  }

  // --- Employee Management ---
  else if(page==='employee-management') {
    fetch('/api/users').then(r=>r.json()).then(users=>{
      let html=`<div style="display:flex; justify-content:space-between; align-items:center;">
          <h2>Employee Management</h2>
          <button onclick="showAddEmployeeForm()" style="padding:8px 12px; background:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer;">➕ Add Employee</button>
        </div>
        <div id="employee-form" style="display:none; margin-top:20px; background:#f9f9f9; padding:20px; border-radius:10px;">
          <h3 id="form-title">Add New Employee</h3>
          <form onsubmit="saveEmployee(event)">
            <input type="hidden" id="emp-id">
            <input type="text" id="emp-name" placeholder="Name" required><br><br>
            <input type="email" id="emp-email" placeholder="Email" required><br><br>
            <input type="text" id="emp-phone" placeholder="Phone"><br><br>
            <input type="text" id="emp-country" placeholder="Country"><br><br>
            <input type="text" id="emp-role" placeholder="Role"><br><br>
            <input type="password" id="emp-password" placeholder="Password" required>
            <select id="emp-status" required>
              <option value="active">Active</option><option value="inactive">Inactive</option>
            </select><br><br>
            <input type="file" id="emp-image"><br><br>
            <button type="submit" style="background:#2196F3;color:white;padding:8px 12px;border:none;border-radius:6px;">Save</button>
          </form>
        </div>
        <div class="employee-grid">`;
      users.forEach(u=>{
        html+=`<div class="employee-card">
          <img src="${u.image || '/static/images/default.png'}" alt="Profile">
          <h4>${u.name}</h4>
          <p>${u.email}</p>
          <p>📱 ${u.phone || 'N/A'}</p>
          <p>🌍 ${u.country || 'N/A'}</p>
          <p class="${u.status==='active'?'status-active':'status-inactive'}">${u.status||'unknown'}</p>
          <p>Role: ${u.role}</p>
          <button onclick="editEmployee(${u.id})" style="background:#FFC107;color:white;border:none;padding:5px 8px;margin:5px;border-radius:5px;">Edit</button>
          <button onclick="deleteEmployee(${u.id})" style="background:#F44336;color:white;border:none;padding:5px 8px;border-radius:5px;">Delete</button>
        </div>`;
      });
      html+="</div>";
      content.innerHTML=html;
    });
  }

  // --- Department Management ---
  else if(page==='department-management') {
    fetch('/api/departments').then(r=>r.json()).then(depts=>{
      let html=`<h2>Department Management</h2>
      <div style="margin-bottom:20px;">
        <input type="hidden" id="dept_id">
        <input type="text" id="dept_name" placeholder="Department Name">
        <input type="text" id="dept_desc" placeholder="Description">
        <button onclick="saveDepartment()" style="padding:5px 10px;background:#2196F3;color:white;border:none;border-radius:4px;">Save</button>
      </div>
      <table>
        <thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Action</th></tr></thead>
        <tbody id="dept_table_body"></tbody>
      </table>`;
      content.innerHTML=html;

      const tbody = document.getElementById('dept_table_body');
      depts.forEach(d=>{
        let row = document.createElement('tr');
        row.innerHTML=`<td>${d.id}</td><td>${d.name}</td><td>${d.description||''}</td>
          <td>
            <button onclick="editDepartment(${d.id}, '${d.name}', '${d.description||''}')">Edit</button>
            <button onclick="deleteDepartment(${d.id})">Delete</button>
          </td>`;
        tbody.appendChild(row);
      });
    });
  }

  // --- Payroll Management ---
  else if(page==='payroll-management') {
    Promise.all([fetch('/api/employees').then(r=>r.json()), fetch('/api/payroll').then(r=>r.json())]).then(([employees, payrolls])=>{
      let html=`<h2>Payroll Management</h2>
      <div style="margin-bottom:20px;">
        <h3>Add Payroll</h3>
        <form id="payroll-form" onsubmit="savePayroll(event)">
          <select id="payroll-employee" required><option value="">Select Employee</option>`;
      employees.forEach(emp=>{ html+=`<option value="${emp.id}">${emp.name}</option>`; });
      html+=`</select>
        <input type="month" id="payroll-month" required>
        <input type="number" id="payroll-basic" placeholder="Basic Salary" required>
        <input type="number" id="payroll-bonus" placeholder="Bonus" value="0">
        <button type="submit" style="background:#2196F3;color:white;padding:5px 10px;border:none;border-radius:5px;">Save</button>
        </form>
      </div>
      <h3>Existing Payrolls</h3>
      <table>
        <thead>
          <tr>
            <th>Employee</th><th>Month</th><th>Basic</th><th>Bonus</th><th>Total</th><th>Status</th><th>Action</th>
          </tr>
        </thead>
        <tbody>`;
      payrolls.forEach(p=>{
        html+=`<tr>
          <td>${p.name}</td>
          <td>${p.month}</td>
          <td>${p.basic}</td>
          <td>${p.bonus}</td>
          <td>${p.total}</td>
          <td>
            <select onchange="updatePayrollStatus(${p.id}, this.value)">
              <option value='Pending' ${p.status==='Pending'?'selected':''}>Pending</option>
              <option value='Paid' ${p.status==='Paid'?'selected':''}>Paid</option>
            </select>
          </td>
          <td>
            <button onclick="deletePayroll(${p.id})" style="background:#F44336;color:white;border:none;padding:3px 6px;border-radius:4px;">Delete</button>
          </td>
        </tr>`;
      });
      html+="</tbody></table>";
      content.innerHTML=html;
    });
  }

  else { content.innerHTML=`<h2>${page.replace('-',' ')}</h2><p>Content coming soon...</p>`; }
}

// ---------------- Payroll Functions ----------------
function savePayroll(event){
  event.preventDefault();
  const formData={user_id: document.getElementById('payroll-employee').value,
    month: document.getElementById('payroll-month').value,
    basic: parseFloat(document.getElementById('payroll-basic').value),
    bonus: parseFloat(document.getElementById('payroll-bonus').value)
  };
  formData.total=formData.basic+formData.bonus;
  fetch('/api/payroll',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(formData)})
    .then(r=>r.json()).then(r=>{ alert(r.message); loadPage('payroll-management'); });
}

function deletePayroll(id){
  if(!confirm('Delete this payroll?')) return;
  fetch('/api/payroll/'+id,{method:'DELETE'}).then(r=>r.json()).then(r=>{ alert(r.message); loadPage('payroll-management'); });
}

function updatePayrollStatus(id,status){
  fetch('/api/payroll_status/'+id,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status})})
    .then(r=>r.json()).then(r=>{ alert(r.message); loadPage('payroll-management'); });
}

// ---------------- Department Functions ----------------
function editDepartment(id,name,desc){
  document.getElementById('dept_id').value=id;
  document.getElementById('dept_name').value=name;
  document.getElementById('dept_desc').value=desc;
}

function saveDepartment(){
  const id = document.getElementById('dept_id').value;
  const name = document.getElementById('dept_name').value;
  const desc = document.getElementById('dept_desc').value;
  if(!name){ alert("Name required"); return; }

  const data={name, description: desc};
  if(id) data.id=id;

  fetch('/api/departments',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
    .then(r=>r.json()).then(res=>{ alert(res.message); loadPage('department-management'); });
}

function deleteDepartment(id){
  if(!confirm("Delete this department?")) return;
  fetch('/api/departments/'+id,{method:'DELETE'})
    .then(r=>r.json()).then(res=>{ alert(res.message); loadPage('department-management'); });
}
</script>

</body>
</html>
